<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <title>iostudio Whiteboard</title>

    <style type="text/css" media="screen">
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html,
        body {
            font-family: Helvetica, sans-serif;
            height: 100%;
            margin: 50px auto 0;
            padding: 20px;
            text-align: center;
            width: 600px;
        }
        #dropzone {
            border:4px dashed red;
        }

        .dragover {
          background-color: orange;  
        }

        #chat-messages-list {
            border: 1px solid #999;
            height: 400px;
            overflow: scroll;
            margin: 1em 0;
            list-style-type: none;
            text-align: left;
            width: 100%;
        }
        #chat-messages-list > li {
            background-color: #deffe0;
            padding: 5px;
        }
        #chat-messages-list > li:nth-child(odd) {
            background-color: #a9ffad;
        }
        #chat-messages-list > li.self {
            background-color: yellow;
        }
        #chat-messages-list > li:nth-child(odd).self {
            background-color: #faffd3;
        }
        #chat-messages-list > li > .user {
            font-weight: bold;
        }
        #chat-messages-list > li > .user:after {
            content: ':';
        }
        #chat input {
            border: 1px solid #999;
            padding: 1em;
            font-size: 1em;
            width: 100%;
        }
    </style>

</head>
<body>
    <div id="dashboard">Drag files here.</div>
    <h2>Files</h2>
    <div id="files-list"></div>
    <h2>Users</h2>
    <div id="users-list"></div>

    <form id="chat">
        <h2>Chat</h2>
        <ul id="chat-messages-list"></ul>
        <input type="text" placeholder="Message Here...">
    </form>

    <script id="template-file" type="text/handlebars">
        <li><a href="/files/{{name}}" download="{{name}}">{{name}} ({{authorID}} at {{timestamp}})</a></li>
    </script>

    <script id="template-user" type="text/handlebars">
        <li id="user{{id}}">{{name}}</li>
    </script>

    <script id="template-chat-message" type="text/handlebars">
        <li id="message{{id}}" class="{{^user}}self{{/user}}"><span class="user">{{#user}}{{user}}{{/user}}{{^user}}You{{/user}}</span> {{message}}</li>
    </script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/mustache.js/0.5.0-dev/mustache.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.0.beta6/handlebars.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.10/socket.io.min.js"></script>
    <script>

        var socket = io.connect('http://'+document.domain+':8080');

        var UserModel = Backbone.Model.extend({
          defaults: {
            'name': 'New User',
            'self': 'true'
          },
          initialize: function () {
            this.on('add', function (user) {
                appController.trigger('newUserAdded', user);
            });
            this.on('remove', function (user) {
                appController.trigger('userRemoved', user);
            });
          }
        });

        var UsersCollection = Backbone.Collection.extend({
          model: UserModel
        });

        var UsersListView = Backbone.View.extend({
            el: '#users-list',
            template: (function () { return $('#template-user').html() }()),
            initialize: function () {
                this.on('add', this.add);
            },
            render: function (user) {
                return Mustache.render(this.template, user);
            },
            add: function (user) {
                var html = this.render(user);
                this.$el.append(html);
            },
            remove: function (user) {
                var $el = this.$el.find('#user'+user.id);
                $el.remove();
            }
        });

        var AppModel = Backbone.Model.extend({
            initialize: function () {
                this.on('change', function () {
                    appController.trigger('change', {
                        model: this,
                        changes: arguments[1].changes
                    });
                });
            }
        });

        var FileModel = Backbone.Model.extend({
            defaults: {
                'name': 'file.txt',
                'data': 'data:',
                'author': 'New Author',
                'timestamp': 'New Date',
                'location': {
                    'offsetX': 0,
                    'offsetY': 0
                }
            }
        });

        var FilesCollection = Backbone.Collection.extend({
            model: FileModel,
            initialize: function () {
                this.on('add', function (file) {
                    appController.trigger('newFileAdded', file);
                });
            }
        });

        var FilesListView = Backbone.View.extend({
            el: '#files-list',
            //template: (function () { return Handlebars.compile( $('#template-file').html() ) }()),
            template: $('#template-file').html(),
            initialize: function () {
                this.on('add', this.add);
            },
            render: function (file) {
                return Mustache.render(this.template, file);
            },
            add: function (file) {
                var html = this.render(file);
                this.$el.append(html);
            }
        });

        var FilesController = Backbone.View.extend({
            initialize: function () {
                var filesCollection = this.filesCollection = new FilesCollection();
                var filesListView = this.filesListView = new FilesListView();
            }
        });

        var ChatModel = Backbone.Model.extend();
        var ChatCollection = Backbone.Collection.extend({
            model: ChatModel
        });
        var ChatMessagesListView = Backbone.View.extend({
            el: '#chat',
            initialize: function () {
                this.$el.$input = this.$el.find('input');
                this.$el.$messagesList = $('#chat-messages-list');
            },
            events: {
                'submit': function (e) {
                    e.preventDefault();
                    var val = this.$el.$input.val();
                    if (val.length > 0) {
                        this.$el.$input.val('');
                        this.trigger('_chatMessageAdded', val);
                    }
                }
            },
            template: $('#template-chat-message').html(),
            render: function (file) {
                return Mustache.render(this.template, file);
            },
            add: function (file) {
                var html = this.render(file);
                this.$el.$messagesList.append(html).scrollTop(99999);
            }

        });
        var ChatController = Backbone.View.extend({
            initialize: function () {
                var t = this;
                var chatCollection = this.chatCollection = new ChatCollection();
                var chatMessagesListView = this.chatMessagesListView = new ChatMessagesListView();
                chatMessagesListView.on('_chatMessageAdded', function (message) {
                    t.chatCollection.add({message:message});
                });
                chatCollection.on('add', function (message) {
                    t.chatMessagesListView.add( message.toJSON() );
                    t.trigger('_chatMessageAdded', message.toJSON() );
                });
                this.on('messageAdded', function (message) {
                    chatCollection.add(message);
                });
            }
        });

        var DashboardView = Backbone.View.extend({
            el: 'body',
            events: {
                'dragover': function () {
                    this.$el.addClass('dragover');
                },
                'dragleave': function () {
                    this.$el.removeClass('dragover');
                },
                'drop': function (e) {
                    e.preventDefault();
                    this.$el.removeClass('dragover');
                    appController.trigger('newFileDropped', e.originalEvent.dataTransfer.files[0]);
                }
            }
        });

        var AppController = Backbone.View.extend({
            initialize: function () {
                var t = this;
                var appModel = new AppModel();
                var dashboardView = new DashboardView();
                var filesCollection = new FilesCollection();
                var filesListView = new FilesListView();
                var usersCollection = new UsersCollection();
                var usersListView = new UsersListView();

                var chatController = new ChatController();

                this.on('newFileDropped', function (file) {
                    var self = usersCollection.where({'self':'true'})[0];
                    var reader = new FileReader();
                    reader.onload = function () {
                        socket.emit('fileAdded', { name: file.name, timestamp: new Date().getTime(), data: this.result, authorID: self.id });
                    };
                    reader.readAsDataURL(file);
                });
                this.on('newFileFromServer', function (file) {
                    filesCollection.add(file);
                });
                this.on('newFileAdded', function (file) {
                    filesListView.trigger('add', file.toJSON() );
                });
                this.on('newUserFromServer', function (user) {
                    usersCollection.add(user);
                    console.log(user);
                });
                this.on('newUserAdded', function (user) {
                    usersListView.trigger('add', user.toJSON() );
                });
                this.on('userRemovedFromServer', function (user) {
                    usersCollection.remove(user);
                });
                this.on('userRemoved', function (user) {
                    usersListView.remove(user);
                });


                chatController.on('_chatMessageAdded', function (message) {
                    if (!message.user) {
                        message.user = socket.socket.sessionid;
                        socket.emit('chatMessageAdded', message);
                    } else {
                        t.growl(message.user, message.message);
                    }
                });

                this.on('debug', function () {
                    console.log(filesCollection);
                });

                this.on('newMessageFromServer', function (message) {

                    if (message.user !== socket.socket.sessionid) {
                        console.log('there was a new message from the server! we will accept it.');
                        chatController.trigger('messageAdded', message);
                    } else {
                        console.log('there was a new message from the server but we will ignore it');
                    }
                });


            },
            growl: function (user, message) {
             if (window.webkitNotifications.checkPermission() === 0) { // 0 is PERMISSION_ALLOWED
                console.log('allowed');
                var note = window.webkitNotifications.createNotification('', user, message);
                note.ondisplay = function() {  var hide = setTimeout(function () { console.log(note); note.close(); }, 2500) };
                note.show();
              } else {
                alert('mind to turn on notifications?');
                window.webkitNotifications.requestPermission();
              }
            }
        });

        appController = new AppController();

        socket.on('_newFile', function (file) {
            appController.trigger('newFileFromServer', file);
        });

        socket.on( '_getAllFiles', function (files) {
            _.each(files, function (file) {
                appController.trigger('newFileFromServer', file);
            });
        });

        socket.on( '_currentUserModified', function (user) {
            user.self = 'true';
            console.log('self modified', user);
            appController.trigger('newUserFromServer', user);
        });

        socket.on( '_userAdded', function (user) {
            console.log('new user');
            appController.trigger('newUserFromServer', user);
        });

        socket.on( '_getAllUsers', function (users) {
            console.log('all users');
            _.each(users, function (user) {
                appController.trigger('newUserFromServer', user);
            });
        });

        socket.on( '_getAllMessages', function (messages) {

            console.log('all messages', messages);
            _.each(messages, function (message) {
                appController.trigger('newMessageFromServer', message);
            });
        });

        socket.on( '_userRemoved', function (user) {
            console.log('removed');
            appController.trigger('userRemovedFromServer', user);
        });

        socket.on( '_error', function (error) {
            alert(error);
        });

        socket.on('_chatMessageAdded', function (message) {
            appController.trigger('newMessageFromServer', message);
        });

        socket.on('_reload', function () {
            window.location = window.location;
        });

    


            test = function () {
                window.webkitNotifications.requestPermission();
            };

        
            $('body').on('click', test);


    </script>
</body>
</html>
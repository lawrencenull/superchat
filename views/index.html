<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <title>iostudio Whiteboard</title>

    <style type="text/css" media="screen">
        * {
            box-sizing: border;
            margin: 0;
            padding: 0;
        }
        html,
        body {
            font-family: Helvetica, sans-serif;
            height: 100%;
            margin: 50px auto 0;
            padding: 20px;
            text-align: center;
            width: 100%;
            background-color: #555;

        }
        #dropzone {
            border:4px dashed red;
        }

        .dragover {
          background-color: orange;  
        }
    </style>

</head>
<body>
    <div id="dashboard">Drag files here.</div>
    <h2>Files</h2>
    <div id="files-list"></div>
    <h2>Users</h2>
    <div id="users-list"></div>
    <script src="http://d3js.org/d3.v2.js"></script>
    <svg id="main" draggable="true"></svg>


    <script id="template-file" type="text/handlebars">
        <li><a href="/files/{{name}}" download="{{name}}">{{name}} ({{authorID}} at {{timestamp}})</a></li>
    </script>

    <script id="template-user" type="text/handlebars">
        <li id="user{{id}}">{{name}}</li>
    </script>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
    <script src="/scripts/drag.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/mustache.js/0.5.0-dev/mustache.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.0.beta6/handlebars.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.10/socket.io.min.js"></script>


        <script>
        (function ($) {
           // d = [100,100];   
            
            var LineModel = Backbone.Model.extend({
                defaults: {
                    coordinates: [{'x':null,'y':null}]
                },
                initialize: function(){

                }
            });
            var LineCollection = Backbone.Collection.extend({
                model: LineModel
            });
            var LineView = Backbone.View.extend({
                el:"#main",
                events :{
                    'dragstart': function(e){
                        var parentOffset = $(e.target).offset();
                        var posX = e.pageX - parentOffset.left;
                        var posY = e.pageY - parentOffset.top;
                        var lineModel = new LineModel({coordinates:[{'x':posX,'y':posY}]});
                        lineCollection.add(lineModel);
                        console.log('new line model!', lineModel);
                        console.log('line collection!', lineCollection.length, lineCollection);
                    },
                    'drag': function(e){
                        var parentOffset = $(e.target).offset();
                        var posX = e.pageX - parentOffset.left;
                        var posY = e.pageY - parentOffset.top;
                        this.trigger('_newPointsAdded', posX, posY);
                        
                    }
                },
                render : function(){
                    var svg = d3.select("#main");
                    //console.log('beep!', lineCollection);
                    _.each(lineCollection.models, function(obj){
                        // var line = new d3.svg.line()
                        //     .x(function(d) { return d.x; })
                        //     .y(function(d) { return d.y; })
                        //     .interpolate('cardinal');

                        // svg.data()
                        //     .append("svg:path")
                        //     .attr("d", line)
                        //     .attr("fill", "#444")
                        //     .attr("stroke", "#aaa")
                        //     .attr("stroke-width", 7);
                        // console.log('beeeee', obj.attributes.coordinates)
                    });
                    // svg.data()
                    //     .append("svg:path")
                    //     .attr("d", line)
                    //     .attr("fill", "#444")
                    //     .attr("stroke", "#aaa")
                    //     .attr("stroke-width", 7);
                }
            });
            var LineController = Backbone.View.extend({
                initialize : function(){
                    var lineView = new LineView();
                    var that = this;
                    // var svg = d3.select("#main");

                    // svg.data([])
                    //     .append("svg:path")
                    //     //.attr("d", line)
                    //     .attr("fill", "#444")
                    //     .attr("stroke", "#aaa")
                    //     .attr("stroke-width", 7);           
                    lineView.on('_newPointsAdded', function(x, y){
                        console.log('new point added ', x ,y);
                        //console.log('line collection', lineCollection)
                        // if(lineCollection.length > 0){
                        //     console.log('true')
                        //     var currentLine = lineCollection.at(lineCollection.length());
                        //     var coordinates = currentLine.get('coordinates');
                        //     var lastPoint = _.last(coordinates);
                        // }else{
                        //     var lastPoint = [0,0];
                        // }
                        
                        // if (that.isWithinThreshold(x, y, lastPoint)){
                        //     coordinates.pop();
                        // }
                        console.log('line collection length', lineCollection.length);
                        var currentLine = lineCollection.at(lineCollection.length - 1);

                        var coordinates = currentLine.get('coordinates');
                        
                        //var lastPoint = _.last(coordinates);

                        coordinates.push({'x': x, 'y' : y});

                        currentLine.set('coordinates', coordinates);
                        lineView.render();
                    });
                    lineCollection.on('change', function(){
                        
                    });
                }
                // isWithinThreshold : function(posX, posY, lastPoint){
                //     var threshold = 3;

                //     if ((posX < lastPoint[0]+threshold && posX > lastPoint[0]-threshold) || (posY < lastPoint[1]+threshold && posY > lastPoint[1]-threshold))
                //     {
                //         return true;
                //     }
                //     else{
                //         return false;
                //     }
                // }
            });

            lineCollection = new LineCollection();
            var lineController = new LineController();

            // function initialize(x, y, line){
            //     var linePoints = [];
            //     for (var i = 0; i < 1; i++){
            //         linePoints.push([x, y]);
            //     }

            //     $('#main').on('drag', function(e){
            //         refresh(e, linePoints, line);
            //     });
            // }        
            // function refresh(e, linePoints, line){
            //     var posX = e.pageX - parentOffset.left;
            //     var posY = e.pageY - parentOffset.top;
                
            //     if ((posX < linePoints[linePoints.length-1][0]+3 && posX > linePoints[linePoints.length-1][0]-3) || (posY < linePoints[linePoints.length-1][1]+3 && posY > linePoints[linePoints.length-1][1]-3)){
            //         linePoints.pop();
            //     }
            //     linePoints.push([posX, posY]);
            //     svg.data([linePoints])
            //         .select("path")                    
            //         // .transition()
            //         // .duration(100)
            //         .attr("d", line);
            // }
            // $('#main').on('dragstart', function(e){
            //     parentOffset = $(this).offset();
            //     var posX = e.pageX - parentOffset.left;
            //     var posY = e.pageY - parentOffset.top;
            //     var line = new d3.svg.line()
            //         .x(function(d) { return d[0]; })
            //         .y(function(d) { return d[1]; })
            //         .interpolate('cardinal');
            //     initialize(posX, posY, line);
            // });
                
        })(jQuery);

    </script>


    <script>

        var socket = io.connect('http://'+document.domain+':8080');

        var UserModel = Backbone.Model.extend({
          defaults: {
            'name': 'New User',
            'self': 'true'
          },
          initialize: function () {
            this.on('add', function (user) {
                appController.trigger('newUserAdded', user);
            });
            this.on('remove', function (user) {
                appController.trigger('userRemoved', user);
            })
          }
        });

        var UsersCollection = Backbone.Collection.extend({
          model: UserModel
        });

        var UsersListView = Backbone.View.extend({
            el: '#users-list',
            template: (function () { return $('#template-user').html() }()),
            initialize: function () {
                this.on('add', this.add);
            },
            render: function (user) {
                return Mustache.render(this.template, user);
            },
            add: function (user) {
                var html = this.render(user);
                this.$el.append(html);
            },
            remove: function (user) {
                var $el = this.$el.find('#user'+user.id);
                $el.remove();
            }
        });

        var AppModel = Backbone.Model.extend({
            initialize: function () {
                this.on('change', function () {
                    appController.trigger('change', {
                        model: this,
                        changes: arguments[1].changes
                    });
                });
            }
        });

        var FileModel = Backbone.Model.extend({
            defaults: {
                'name': 'file.txt',
                'data': 'data:',
                'author': 'New Author',
                'timestamp': 'New Date',
                'location': {
                    'offsetX': 0,
                    'offsetY': 0
                }
            }
        });

        var FilesCollection = Backbone.Collection.extend({
            model: FileModel,
            initialize: function () {
                this.on('add', function (file) {
                    appController.trigger('newFileAdded', file);
                });
            }
        });

        var FilesListView = Backbone.View.extend({
            el: '#files-list',
            //template: (function () { return Handlebars.compile( $('#template-file').html() ) }()),
            template: (function () { return $('#template-file').html() }()),
            initialize: function () {
                this.on('add', this.add);
            },
            render: function (file) {
                return Mustache.render(this.template, file);
            },
            add: function (file) {
                var html = this.render(file);
                this.$el.append(html);
            }
        });

        var FilesController = Backbone.View.extend({
            initialize: function () {
                var filesCollection = this.filesCollection = new FilesCollection();
                var filesListView = this.filesListView = new FilesListView();
            }
        });

        var DashboardView = Backbone.View.extend({
            el: 'body',
            events: {
                'dragover': function () {
                    this.$el.addClass('dragover');
                },
                'dragleave': function () {
                    this.$el.removeClass('dragover');
                },
                'drop': function (e) {
                    e.preventDefault();
                    this.$el.removeClass('dragover');
                    appController.trigger('newFileDropped', e.originalEvent.dataTransfer.files[0]);
                }
            }
        });

        var AppController = Backbone.View.extend({
            initialize: function () {
                var appModel = new AppModel();
                var dashboardView = new DashboardView();
                var filesCollection = new FilesCollection();
                var filesListView = new FilesListView();
                var usersCollection = new UsersCollection();
                var usersListView = new UsersListView();

                this.on('newFileDropped', function (file) {
                    var self = usersCollection.where({'self':'true'})[0];
                    var reader = new FileReader();
                    reader.onload = function () {
                        socket.emit('fileAdded', { name: file.name, timestamp: new Date().getTime(), data: this.result, authorID: self.id });
                    };
                    reader.readAsDataURL(file);
                });
                this.on('newFileFromServer', function (file) {
                    filesCollection.add(file);
                });
                this.on('newFileAdded', function (file) {
                    filesListView.trigger('add', file.toJSON() );
                });
                this.on('newUserFromServer', function (user) {
                    usersCollection.add(user);
                    console.log(user);
                });
                this.on('newUserAdded', function (user) {
                    usersListView.trigger('add', user.toJSON() );
                });
                this.on('userRemovedFromServer', function (user) {
                    usersCollection.remove(user);
                });
                this.on('userRemoved', function (user) {
                    usersListView.remove(user);
                });

                this.on('debug', function () {
                    console.log(filesCollection);
                });
            }
        });

        appController = new AppController();

        socket.on('_newFile', function (file) {
            appController.trigger('newFileFromServer', file);
        });

        socket.on( '_getAllFiles', function (files) {
            _.each(files, function (file) {
                appController.trigger('newFileFromServer', file);
            });
        });

        socket.on( '_currentUserModified', function (user) {
            user.self = 'true';
            console.log('self modified', user);
            appController.trigger('newUserFromServer', user);
        });

        socket.on( '_userAdded', function (user) {
            console.log('new user');
            appController.trigger('newUserFromServer', user);
        });

        socket.on( '_getAllUsers', function (users) {
            console.log('all users');
            _.each(users, function (user) {
                appController.trigger('newUserFromServer', user);
            });
        });

        socket.on( '_userRemoved', function (user) {
            console.log('removed');
            appController.trigger('userRemovedFromServer', user);
        });

        socket.on( '_error', function (error) {
            alert(error);
        });


    </script>
</body>
</html>